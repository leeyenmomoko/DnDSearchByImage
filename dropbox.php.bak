<!DOCTYPE HTML>
<html>
<head>
	<title>test upload</title>
	<script type="text/javascript" src="http://js.leeyen.idv.tw/lib/jquery/jquery-1.8.2.min.js"></script>
	<script type="text/javascript" src="http://js.leeyen.idv.tw/lib/YenZ/DnD.js"></script>
	<script type="text/javascript">
		$(document).ready(function(){
			var holder = $("#dropZone").get(0), 
				fileContainer = $("#dropZone .fileContainer").get(0);
			var tests = {
				filereader: typeof FileReader != 'undefined',
				dnd: 'draggable' in document.createElement('span'),
				formdata: !!window.FormData,
				progress: "upload" in new XMLHttpRequest,
                
		    };
			var dropped = false;
            
			if(tests.dnd){
				document.ondragenter = function(){
                    $('#dropZone').show();
                    return false;
                };
                document.onmouseover = function(){
                    if(dropped === false){
                        $('#dropZone').hide();
                    }
                };
                holder.ondragover = function(){
                    this.className = 'hover';
                    dropped = true;
                    return false;
                };
				holder.ondragleave = function(){
                    this.className = '';
                    dropped = false;
                    return false;
                };
				holder.ondrop = function (event) {
					event.preventDefault && event.preventDefault();
					
					//remove holder's class 
					this.className = '';
					readDropFiles(event);
                    document.onmouseover = function(){
                    };
					function readDropFiles(target){
                        if(typeof target.dataTransfer.files != 'undefined'){
                            var items = target.dataTransfer.files;
                            var itemsCount = items.length;
                            if(itemsCount>0){
                                for(var i = 0; i<itemsCount; i++){
                                    var type = items[i].type;
                                    switch(type){
                                        case 'image/jpeg':
                                            if(typeof items[i].getAsFile != 'undefined'){
                                                previewFile(items[i].getAsFile(), "file");
                                            }
                                            else{
                                                previewFile(items[i], "file");
                                            }
                                            break;
                                    }
                                }
                            }
                            else{
                                if(typeof target.dataTransfer.items != 'undefined'){
                                    itemsCount = target.dataTransfer.items.length;
                                }
                                else if(typeof event.dataTransfer.mozItemCount!= 'undefined'){
                                    itemsCount = event.dataTransfer.mozItemCount;
                                }
                                if(itemsCount>0){
                                    var data = target.dataTransfer.getData("text/html");
                                    var imgs = $('<p></p>').append(data).find('img');
                                    if(imgs.length){
                                        $.each(imgs, function(index, el){
                                            previewFile(el.src, "url");
                                        });
                                    }
                                    else{
                                        alert('image not found.');
                                    }
                                }
                            }
                        }
					}
					function uploadFile(file, progress){
						var formData = tests.formdata ? new FormData() : null;
						if(tests.formdata){
							formData.append('file', file);
						}
						// now post a new XHR request
						var xhr = new XMLHttpRequest();
						xhr.open('POST', 'upload.php');
						xhr.upload.onprogress = function (event) {
							if(event.lengthComputable){
								var complete = (event.loaded / event.total * 100 | 0);
								progress.value = progress.innerHTML = complete;
							}
						};
						xhr.onload = function (event) {
							if (xhr.status === 200) {
								progress.value = progress.innerHTML = 100;
								setTimeout(function(){
									// when uploaded remove progressbar and show text completed.
									progress.parentNode.appendChild(document.createTextNode(xhr.responseText));
									progress.parentNode.removeChild(progress);
								}, 500);
                                console.log('uploaded.');
							}
							else{
								console.log('Something went terribly wrong...');
							}
						};
						
						xhr.send(formData);
					}

					function previewFile(file, type){
                        switch(type){
                            case 'file':
                                var reader = new FileReader();
                                reader.onload = function (event) {
                                    var image = new Image();
                                    var preview = document.createElement('div');
                                    var progressContainer = document.createElement('div');
                                    var progress = document.createElement('progress');
                                    progress.min = 0;
                                    progress.max = 100;
                                    progress.value = 0;
                                    progressContainer.appendChild(progress);
                                    progressContainer.className = 'progress';
                                    image.src = event.target.result;
                                    preview.className = 'preview';
                                    preview.appendChild(progressContainer);
                                    preview.appendChild(image);
                                    fileContainer.appendChild(preview);
                                    uploadFile(file, progress);
                                };
                                reader.readAsDataURL(file);
                                break;
                            case 'url':
                                var image = new Image();
                                var preview = document.createElement('div');
                                var progressContainer = document.createElement('div');
                                progressContainer.className = 'progress';
                                image.src = file;
                                preview.className = 'preview';
                                preview.appendChild(progressContainer);
                                preview.appendChild(image);
                                progressContainer.appendChild(document.createTextNode('Ready'));
                                fileContainer.appendChild(preview);
                                break;
                        }
						
					}
					
					return false;
				};
			}
			else{
				console.log("don't support dnd");
			}
			//$('#dropZone').get(0).addEventListener('drop', dragInit("drop"), false);		
		});
	</script>
	<style type="text/css">
		#dropZone{
			border: 5px dashed #C6C6C6;
			color: #636363;
			font-size: 150%;
			width: 800px;
			min-height: 50px;
			padding: 10px;
            display: none;
		}
		#dropZone.hover{
			border-color: #45FF45;
		}
		#dropZone .tip{
			padding: 25px;
			text-align: center;
		}
		#dropZone .fileContainer .preview{
			position: relative;
			width: 25%;
			display: inline-block;
			text-align: center;
		}
		#dropZone .fileContainer .preview img{
			width: 100%;
		}
		#dropZone .fileContainer .preview .progress{
			position: absolute;
			width: 100%;
			text-align: center;
			bottom: 10px;
			font-size: 75%;
		}
		#dropZone .fileContainer .preview .progress progress{
			width: 80%;
		}
	</style>
</head>
<body>
    <div class="upload"><input type="file" name="file" /></div>
	<div id="dropZone">
		<div class="tip">Drop files here.</div>
		<div class="fileContainer"></div>
	</div>
</body>
</html>